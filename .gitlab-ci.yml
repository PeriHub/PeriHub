stages:
  - build

build_job:
  image: docker/compose:latest
  tags:
    - wsl
  stage: build
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USER" --password-stdin
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo -e "GITLAB_TOKEN=$GIT_TOKEN\nGITLAB_USER=f_testpa\nPERIDOX=False\nEXTERNAL=False\nFASERVICES=True" >> .env
    - docker pull registry.gitlab-test.dlr.de/hess_ja/images/peri_hub_api_image || true
    - docker pull registry.gitlab-test.dlr.de/hess_ja/images/peri_hub_gui_image || true
    - docker pull registry.gitlab-test.dlr.de/hess_ja/images/peridigm_image || true
    - docker pull registry.gitlab-test.dlr.de/hess_ja/images/cron_image || true
    - docker build --pull --cache-from peri_hub_api_image --tag registry.gitlab-test.dlr.de/hess_ja/images/peri_hub_api_image api/.
    - docker build --pull --cache-from peri_hub_gui_image --tag registry.gitlab-test.dlr.de/hess_ja/images/peri_hub_gui_image gui/.
    - docker build --pull --cache-from peridigm_image --tag registry.gitlab-test.dlr.de/hess_ja/images/peridigm_image peridigm/.
    - docker build --pull --cache-from cron_image --tag registry.gitlab-test.dlr.de/hess_ja/images/cron_image cron/.
    - docker push registry.gitlab-test.dlr.de/hess_ja/images/peri_hub_api_image
    - docker push registry.gitlab-test.dlr.de/hess_ja/images/peri_hub_gui_image
    - docker push registry.gitlab-test.dlr.de/hess_ja/images/peridigm_image
    - docker push registry.gitlab-test.dlr.de/hess_ja/images/cron_image
  after_script:
    - docker logout