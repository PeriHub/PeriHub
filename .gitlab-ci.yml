variables: &globals
  CI_REGISTRY_PATH: "harbor.fa-services.intra.dlr.de/hess_ja/"

stages:
  - build

build_api_job:
  stage: build
  extends: [.build_before_script_template]
  only:
    refs:
      - main
    changes:
      - api/**/*
  script:
    - docker build --build-arg EXTERNAL=False -t peri_hub_api_image api/. #--no-cache
    - docker tag peri_hub_api_image ${CI_REGISTRY_PATH}peri_hub_api_image
    - docker push ${CI_REGISTRY_PATH}peri_hub_api_image

build_gui_job:
  stage: build
  extends: [.build_before_script_template]
  only:
    refs:
      - main
    changes:
      - gui/**/*
  script:
    - docker build -t peri_hub_gui_image gui/.
    - docker tag peri_hub_gui_image ${CI_REGISTRY_PATH}peri_hub_gui_image
    - docker push ${CI_REGISTRY_PATH}peri_hub_gui_image

build_cron_job:
  stage: build
  extends: [.build_before_script_template]
  only:
    refs:
      - main
    changes:
      - cron/**/*
  script:
    - docker build -t ${CI_REGISTRY_PATH}cron_image cron/.
    - docker push ${CI_REGISTRY_PATH}cron_image

build_paraview_job:
  stage: build
  extends: [.build_before_script_template]
  only:
    refs:
      - main
    changes:
      - paraview/**/*
  script:
    - docker build -t ${CI_REGISTRY_PATH}paraview_image paraview/.
    - docker push ${CI_REGISTRY_PATH}paraview_image

.build_before_script_template:
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USER" --password-stdin
    - echo "$HARBOR_KEY" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY_PATH
    - echo -e "GITLAB_TOKEN=$GIT_TOKEN\nGITLAB_USER=f_testpa\nPERIDOX=False\nEXTERNAL=False" >> .env
  after_script:
    - docker logout

.deploy_before_script_template:
  before_script:
    - echo "$HARBOR_KEY" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY_PATH
  after_script:
    - docker logout
