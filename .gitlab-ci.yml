variables: &globals
  CI_REGISTRY_PATH: "registry.gitlab-test.dlr.de/hess_ja/images/"

stages:
  - build
  - deploy

build_api_job:
  stage: build
  extends: [.build_before_script_template]
  only:
    changes:
      - api/**/*
  script:
    # - docker pull ${CI_REGISTRY_PATH}peri_hub_api_image || true
    - docker build --build-arg EXTERNAL=False --build-arg FASERVICES=True -t peri_hub_api_image api/. #--no-cache 
    - docker tag peri_hub_api_image ${CI_REGISTRY_PATH}peri_hub_api_image
    - docker push ${CI_REGISTRY_PATH}peri_hub_api_image

build_gui_job:
  stage: build
  extends: [.build_before_script_template]
  only:
    changes:
      - gui/**/*
  script:
    # - docker pull ${CI_REGISTRY_PATH}peri_hub_gui_image || true
    - docker build -t peri_hub_gui_image --build-arg FASERVICES=True gui/.
    - docker tag peri_hub_gui_image ${CI_REGISTRY_PATH}peri_hub_gui_image
    - docker push ${CI_REGISTRY_PATH}peri_hub_gui_image

build_cron_job:
  stage: build
  extends: [.build_before_script_template]
  only:
    changes:
      - cron/**/*
  script:
    # - docker pull ${CI_REGISTRY_PATH}cron_image || true
    - docker build -t ${CI_REGISTRY_PATH}cron_image cron/. 
    - docker push ${CI_REGISTRY_PATH}cron_image

deploy_api_job:
  stage: deploy
  tags: 
    - wsl
  extends: [.deploy_before_script_template]
  only:
    changes:
      - api/**/*
  script:
    - docker pull ${CI_REGISTRY_PATH}peri_hub_api_image
    - docker container stop periHubApi || true
    - docker container rm periHubApi || true
    - docker run --name periHubApi -d -p 6020:80 -v peridigm_volume:/app/peridigmJobs -v paraView_volume:/app/paraView -v secrets:/app/certs --network peridigm ${CI_REGISTRY_PATH}peri_hub_api_image
    - docker exec periHubApi bash -c "ssh-keyscan 129.247.54.37 > /root/.ssh/known_hosts" || true
    - docker exec periHubApi bash -c "ssh-keyscan cara.dlr.de >> /root/.ssh/known_hosts" || true

deploy_gui_job:
  stage: deploy
  tags: 
    - wsl
  extends: [.deploy_before_script_template]
  only:
    changes:
      - gui/**/*
  script:
    - docker pull ${CI_REGISTRY_PATH}peri_hub_gui_image
    - docker container stop periHubGui || true
    - docker container rm periHubGui || true
    - docker run --name periHubGui -d -p 6010:443 -v secrets:/app/certs ${CI_REGISTRY_PATH}peri_hub_gui_image

deploy_cron_job:
  stage: deploy
  tags: 
    - wsl
  extends: [.deploy_before_script_template]
  only:
    changes:
      - cron/**/*
  script:
    - docker pull ${CI_REGISTRY_PATH}cron_image
    - docker container stop periHubCron || true
    - docker container rm periHubCron || true
    - docker run --name periHubCron -d -p 6040:80 ${CI_REGISTRY_PATH}cron_image

deploy_peridigm_job:
  stage: deploy
  tags: 
    - wsl
  extends: [.deploy_before_script_template]
  script:
    - docker pull ${CI_REGISTRY_PATH}peridigm_image
    - docker container stop periHubPeridigm || true
    - docker container rm periHubPeridigm || true
    - docker run --name periHubPeridigm -d -p 6030:80 -v peridigm_volume:/app/peridigmJobs --network peridigm ${CI_REGISTRY_PATH}peridigm_image

.build_before_script_template:
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_LANG: en_US.UTF-8
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_VERIFY: 1
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
    DOCKER_AUTH_CONFIG: '{ "auths": { "$CI_REGISTRY": { "auth": "$GIT_AUTH" }, "https://index.docker.io/v1/": { "auth": "$DOCKER_AUTH" }}}'
    FF_ENABLE_BASH_EXIT_CODE_CHECK: 1
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USER" --password-stdin
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    - echo -e "GITLAB_TOKEN=$GIT_TOKEN\nGITLAB_USER=f_testpa\nPERIDOX=False\nEXTERNAL=False\nFASERVICES=True" >> .env
  after_script:
    - docker logout

.deploy_before_script_template:
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  after_script:
    - docker logout



