variables: &globals
  CI_REGISTRY_PATH: "harbor.fa-services.intra.dlr.de/hess_ja/"

stages:
  - Static Analysis
  - Test
  - Build

flake8:
  stage: Static Analysis
  image: "python:3.8"
  only:
    refs:
      - main
    changes:
      - api/**/*
  allow_failure: true
  before_script:
    - pip install -r api/requirements.txt
    - pip install flake8 flake8-junit-report
    - cd api/app
  script:
    - flake8 --output-file=flake8.txt
    - flake8_junit flake8.txt flake8_junit.xml
  artifacts:
    when: always
    reports:
      junit: api/app/flake8_junit.xml

pylint:
  stage: Static Analysis
  image: "python:3.8"
  only:
    refs:
      - main
    changes:
      - api/**/*
  allow_failure: true
  before_script:
    - pip install -r api/requirements.txt
    - pip install pylint pylint-junit
    - cd api/app
  script:
    - pylint --output-format=junit:pylint.xml *
  artifacts:
    when: always
    reports:
      junit: api/app/pylint.xml

unit_test:
  stage: Test
  image: "python:3.8"
  only:
    refs:
      - main
    changes:
      - api/**/*
  allow_failure: true
  before_script:
    - pip install -r api/requirements.txt
    - pip install pytest
    - cd api/app
  script:
    - python3 -m pytest -v --junitxml=report.xml
  artifacts:
    when: always
    reports:
      junit: api/app/report.xml

build_api_job:
  stage: Build
  extends: [.build_before_script_template]
  only:
    refs:
      - main
    changes:
      - api/**/*
  script:
    - docker build --build-arg EXTERNAL=False -t peri_hub_api_image api/. #--no-cache
    - docker tag peri_hub_api_image ${CI_REGISTRY_PATH}peri_hub_api_image
    - docker push ${CI_REGISTRY_PATH}peri_hub_api_image

build_gui_job:
  stage: Build
  extends: [.build_before_script_template]
  only:
    refs:
      - main
    changes:
      - gui/**/*
  script:
    - docker build -t peri_hub_gui_image gui/.
    - docker tag peri_hub_gui_image ${CI_REGISTRY_PATH}peri_hub_gui_image
    - docker push ${CI_REGISTRY_PATH}peri_hub_gui_image

build_cron_job:
  stage: Build
  extends: [.build_before_script_template]
  only:
    refs:
      - main
    changes:
      - cron/**/*
  script:
    - docker build -t ${CI_REGISTRY_PATH}cron_image cron/.
    - docker push ${CI_REGISTRY_PATH}cron_image

build_paraview_job:
  stage: Build
  extends: [.build_before_script_template]
  only:
    refs:
      - main
    changes:
      - paraview/**/*
  script:
    - docker build -t ${CI_REGISTRY_PATH}paraview_image paraview/.
    - docker push ${CI_REGISTRY_PATH}paraview_image

build_trame_job:
  stage: Build
  extends: [.build_before_script_template]
  only:
    refs:
      - main
    changes:
      - trame/**/*
  script:
    - docker build -t ${CI_REGISTRY_PATH}trame_image trame/.
    - docker push ${CI_REGISTRY_PATH}trame_image

.build_before_script_template:
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USER" --password-stdin
    - echo "$HARBOR_KEY" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY_PATH
    - echo -e "GITHUB_TOKEN=$GIT_TOKEN\nGITHUB_USER=f_testpa\nEXTERNAL=False" >> .env
  after_script:
    - docker logout

.deploy_before_script_template:
  before_script:
    - echo "$HARBOR_KEY" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY_PATH
  after_script:
    - docker logout
